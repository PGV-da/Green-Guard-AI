<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content />
    <meta name="author" content />

    <title>Green Guardian</title>

    <!-- Custom fonts for this template-->
    <link href="{{ url_for('static', filename='vendor/fontawesome-free/css/all.min.css') }}" rel="stylesheet"
        type="text/css" />

    <!-- Custom styles for this template-->
    <link href="{{ url_for('static', filename='css/gg.css') }}" rel="stylesheet" />

    <!-- Custom styles for commodity prices -->
    <link href="{{ url_for('static', filename='css/commodity-prices.css') }}" rel="stylesheet" />
</head>

<body id="page-top">
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-info sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- Sidebar - Brand -->
            <br />
            <a class="sidebar-brand d-flex align-items-center justify-content-center"
                href="{{ url_for('general.index') }}">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-seedling"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Green Guardian</div>
            </a>
            <br />
            <!-- Divider -->
            <hr class="sidebar-divider my-0" />

            <!-- Nav Item - Dashboard -->

            <!-- Divider -->
            <hr class="sidebar-divider" />

            <!-- Heading -->
            <div class="sidebar-heading">Plant</div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseTwo"
                    aria-expanded="true" aria-controls="collapseTwo">
                    <i class="fas fa-fw fa-leaf"></i>
                    <span>Garden</span>
                </a>
                <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Components:</h6>
                        <a class="collapse-item" href="{{ url_for('general.mycrop') }}">My Crops</a>
                    </div>
                </div>
            </li>

            <!-- Nav Item - Utilities Collapse Menu -->
            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapseUtilities"
                    aria-expanded="true" aria-controls="collapseUtilities">
                    <i class="fas fa-clock"></i>
                    <span>Forecasting</span>
                </a>
                <div id="collapseUtilities" class="collapse" aria-labelledby="headingUtilities"
                    data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Menu:</h6>
                        <a class="collapse-item" href="{{ url_for('commodityprice.commodityprice')
 }}">Commodity prices</a>
                        <a class="collapse-item" href="{{ url_for('weather.current_weather') }}">Current
                            Weather</a>
                        <a class="collapse-item" href="{{ url_for('weather.upcoming_weather') }}">Upcoming
                            Weather</a>
                        <a class="collapse-item" href="{{ url_for('news.news') }}">News
                            Updates</a>
                    </div>
                </div>
            </li>

            <li class="nav-item">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-brain"></i>
                    <span>AI</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded">
                        <h6 class="collapse-header">Options:</h6>
                        <a class="collapse-item" href="{{ url_for('disease.diseasedetection') }}">Disease
                            Detection</a>
                        <a class="collapse-item" href="{{ url_for('crop.crop_recommendation') }}">Crop
                            Recommenation</a>
                        <a class="collapse-item" href="{{ url_for('fertilizer.fertilizer_recommendation') }}">Fertilizer
                            Recommendation</a>
                        <a class="collapse-item" href="{{ url_for('price.price_prediction')
 }}">Price Prediction</a>
                        <a class="collapse-item" href="{{ url_for('chat.chatassistant') }}">Chat Assistant</a>
                    </div>
                </div>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider" />

            <!-- Heading -->
            <div class="sidebar-heading">Connect</div>

            <!-- Nav Item - Pages Collapse Menu -->

            <!-- Nav Item - Charts -->
            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('community.community') }}">
                    <i class="fas fa-fw fa-users"></i>
                    <span>Community</span>
                </a>
            </li>
            <hr class="sidebar-divider d-none d-md-block" />
            <div class="sidebar-heading">Others</div>

            <!-- Nav Item - Tables -->

            <li class="nav-item">
                <a class="nav-link" href="{{ url_for('general.aboutus') }}">
                    <i class="fas fa-info-circle"></i>
                    <span>About us</span></a>
            </li>
            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block" />

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Search -->
                    <form
                        class="d-none d-sm-inline-block form-inline mr-auto ml-md-3 my-2 my-md-0 mw-100 navbar-search">
                        <div class="input-group">
                            <input type="text" class="form-control bg-light border-0 small" placeholder="Search for..."
                                aria-label="Search" aria-describedby="basic-addon2" />
                            <div class="input-group-append">
                                <button class="btn btn-info" type="button">
                                    <i class="fas fa-search fa-sm"></i>
                                </button>
                            </div>
                        </div>
                    </form>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">
                        <!-- Nav Item - Search Dropdown (Visible Only XS) -->
                        <li class="nav-item dropdown no-arrow d-sm-none">
                            <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-search fa-fw"></i>
                            </a>
                            <!-- Dropdown - Messages -->
                            <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                                aria-labelledby="searchDropdown">
                                <form class="form-inline mr-auto w-100 navbar-search">
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-light border-0 small"
                                            placeholder="Search for..." aria-label="Search"
                                            aria-describedby="basic-addon2" />
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button">
                                                <i class="fas fa-search fa-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </li>

                        <!-- Nav Item - Alerts -->
                        <li class="nav-item dropdown no-arrow mx-1">
                            <a class="nav-link dropdown-toggle" href="#" id="alertsDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-bell fa-fw"></i>
                                <!-- Counter - Alerts -->
                            </a>
                            <!-- Dropdown - Alerts -->
                            <div class="dropdown-list dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="alertsDropdown">
                                <h6 class="dropdown-header">Alerts</h6>

                                <a class="dropdown-item text-center small text-gray-500" href="#">Show All Alerts</a>
                            </div>
                        </li>

                        <div class="topbar-divider d-none d-sm-block"></div>

                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small"></span>
                                <i class="fas fa-bars"></i>
                                <!-- Three-line icon -->
                            </a>
                            <!-- Dropdown - User Information -->
                            <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Settings
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>
                    </ul>
                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container my-3 mt-3 commodity-prices-container">
                    <div class="commodity-prices-inner">
                        <h1 class="commodity-prices-heading">Current Daily Price of Various Commodities<span class="text-success">🌱</span></h1>
                        <p class="commodity-prices-paragraph">
                            The displayed data is sourced from the <a href="https://data.gov.in">data.gov.in</a> open-source platform. There may occasionally be human errors, so the prices shown might sometimes be incorrect.
                        </p>

                        <div id="filterContainer" class="hidden">
                            <!-- Dynamic Dropdowns (hidden by default) -->
                            <select id="dateFilter">
                                <option value="">All Dates</option>
                            </select>
                            <select id="stateFilter">
                                <option value="">All States</option>
                            </select>
                            <select id="districtFilter">
                                <option value="">All Districts</option>
                            </select>
                            <select id="commodityFilter">
                                <option value="">All Commodities</option>
                            </select>
                        </div>
                        <br>

                        <div class="table-wrapper">
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>No.</th>
                                            <th>State</th>
                                            <th>District</th>
                                            <th>Market</th>
                                            <th>Commodity</th>
                                            <th>Variety</th>
                                            <th>Grade</th>
                                            <th>Arrival Date</th>
                                            <th>Min Price</th>
                                            <th>Max Price</th>
                                            <th>Modal Price</th>
                                        </tr>
                                    </thead>
                                    <tbody id="data-table-body">
                                        <tr>
                                            <td colspan="11">Loading data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Pagination Controls -->
                        <div id="pagination" class="pagination hidden">
                            <button id="prevPage">Previous</button>
                            <span id="pageInfo"></span>
                            <button id="nextPage">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- End of Page Wrapper -->
            <script>
                let allData = []; // Store all fetched data
                let filteredData = []; // Store filtered data for pagination
                const rowsPerPage = 15; // Show 15 rows per page
                let currentPage = 1; // Track current page

                // List of valid states
                const validStates = [
                    "Andaman and Nicobar", "Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar",
                    "Chandigarh", "Chattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh",
                    "Jammu and Kashmir", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh",
                    "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "NCT of Delhi", "Nagaland",
                    "Odisha", "Pondicherry", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu",
                    "Telangana", "Tripura", "Uttar Pradesh", "Uttrakhand", "West Bengal"
                ];

                // Fetch data when the page loads
                window.addEventListener("load", async function () {
                    try {
                        const response = await fetch("/api/commodity-prices");
                        if (!response.ok) throw new Error("Network response was not OK");

                        allData = await response.json();
                        const tableBody = document.getElementById("data-table-body");
                        tableBody.innerHTML = "";

                        if (allData.length === 0) {
                            tableBody.innerHTML = "<tr><td colspan='11' class='py-4'>No data available.</td></tr>";
                            return;
                        }

                        // Show filter container and populate dropdowns if data exists
                        const filterContainer = document.getElementById("filterContainer");
                        filterContainer.classList.remove("hidden");

                        // Populate all dropdowns, including the new date filter
                        populateDropdown("dateFilter", allData, "Arrival_Date");
                        populateDropdown("stateFilter", allData, "State", validStates);
                        populateDropdown("districtFilter", allData, "District");
                        populateDropdown("commodityFilter", allData, "Commodity");

                        // Initialize filtered data and display first page
                        filterAndDisplayData();
                    } catch (error) {
                        console.error("Error fetching data:", error);
                        document.getElementById("data-table-body").innerHTML = "<tr><td colspan='11' class='py-4 text-red-500'>Error fetching data.</td></tr>";
                    }
                });

                // Function to populate dropdowns dynamically
                function populateDropdown(elementId, data, key, validOptions = null) {
                    const dropdown = document.getElementById(elementId);
                    dropdown.innerHTML = "<option value=''>All " + (key === "Arrival_Date" ? "Dates" : key + "s") + "</option>";
                    let uniqueValues = [...new Set(data.map(item => item[key] || "-"))].sort();

                    if (validOptions) {
                        uniqueValues = uniqueValues.filter(value => validOptions.includes(value));
                    }

                    uniqueValues.forEach(value => {
                        const option = document.createElement("option");
                        option.value = value;
                        option.textContent = value;
                        dropdown.appendChild(option);
                    });
                }

                // Filter and display data with pagination
                function filterAndDisplayData() {
                    const dateFilter = document.getElementById("dateFilter").value;
                    const stateFilter = document.getElementById("stateFilter").value;
                    const districtFilter = document.getElementById("districtFilter").value;
                    const commodityFilter = document.getElementById("commodityFilter").value;
                    const tableBody = document.getElementById("data-table-body");
                    tableBody.innerHTML = "";

                    // Filter the data
                    filteredData = allData.filter(item => {
                        return (
                            (!dateFilter || item.Arrival_Date === dateFilter) &&
                            (!stateFilter || item.State === stateFilter) &&
                            (!districtFilter || item.District === districtFilter) &&
                            (!commodityFilter || item.Commodity === commodityFilter)
                        );
                    });

                    if (filteredData.length === 0) {
                        tableBody.innerHTML = "<tr><td colspan='11' class='py-4'>No matching data.</td></tr>";
                        document.getElementById("pagination").classList.add("hidden");
                        return;
                    }

                    // Show pagination controls
                    document.getElementById("pagination").classList.remove("hidden");
                    currentPage = 1; // Reset to first page on filter change
                    displayPage(currentPage);
                }

                // Display a specific page of data
                function displayPage(page) {
                    const tableBody = document.getElementById("data-table-body");
                    tableBody.innerHTML = "";

                    const start = (page - 1) * rowsPerPage;
                    const end = start + rowsPerPage;
                    const paginatedData = filteredData.slice(start, end);

                    paginatedData.forEach((item, index) => {
                        const globalIndex = start + index + 1; // For continuous numbering
                        const row = `
                    <tr>
                        <td class="py-2 px-4">${globalIndex}</td>
                        <td class="py-2 px-4">${item.State || "-"}</td>
                        <td class="py-2 px-4">${item.District || "-"}</td>
                        <td class="py-2 px-4">${item.Market || "-"}</td>
                        <td class="py-2 px-4">${item.Commodity || "-"}</td>
                        <td class="py-2 px-4">${item.Variety || "-"}</td>
                        <td class="py-2 px-4">${item.Grade || "-"}</td>
                        <td class="py-2 px-4">${item.Arrival_Date || "-"}</td>
                        <td class="py-2 px-4">${item.Min_Price || "-"}.00/quintal</td>
                        <td class="py-2 px-4">${item.Max_Price || "-"}.00/quintal</td>
                        <td class="py-2 px-4">${item.Modal_Price || "-"}.00/quintal</td>
                    </tr>
                `;
                        tableBody.innerHTML += row;
                    });

                    // Update pagination controls
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    document.getElementById("pageInfo").textContent = `${page} of ${totalPages}`;
                    document.getElementById("prevPage").disabled = page === 1;
                    document.getElementById("nextPage").disabled = page === totalPages;
                }

                // Add event listeners to dropdowns for filtering
                document.getElementById("dateFilter").addEventListener("change", filterAndDisplayData);
                document.getElementById("stateFilter").addEventListener("change", filterAndDisplayData);
                document.getElementById("districtFilter").addEventListener("change", filterAndDisplayData);
                document.getElementById("commodityFilter").addEventListener("change", filterAndDisplayData);

                // Add event listeners for pagination buttons
                document.getElementById("prevPage").addEventListener("click", () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayPage(currentPage);
                    }
                });

                document.getElementById("nextPage").addEventListener("click", () => {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayPage(currentPage);
                    }
                });
            </script>
            <!-- Scroll to Top Button-->
            <a class="scroll-to-top rounded" href="#page-top">
                <i class="fas fa-angle-up"></i>
            </a>

            <!-- Logout Modal-->
            <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
                aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Ready to
                                Leave?</h5>
                            <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            Select "Logout" below if you are ready to end your current
                            session.
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" type="button" data-dismiss="modal">
                                Cancel
                            </button>
                            <a class="btn btn-primary" href="/">Logout</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bootstrap core JavaScript-->
            <script src="{{ url_for('static', filename='vendor/jquery/jquery.min.js') }}"></script>
            <script src="{{ url_for('static', filename='vendor/bootstrap/js/bootstrap.bundle.min.js') }}"></script>
            <script src="{{ url_for('static', filename='vendor/jquery-easing/jquery.easing.min.js') }}"></script>
            <script src="{{ url_for('static', filename='js/gg.min.js') }}"></script>

</body>

</html>